import { NextRequest,NextResponse } from 'next/server'; import { z } from 'zod'; import { sendOwnerEmail } from '@/lib/email'; import { getSupabaseServiceClient } from '@/server/supabase'; const schema=z.object({name:z.string().min(1),email:z.string().email(),phone:z.string().min(7),message:z.string().optional()}); export async function POST(req:NextRequest){ const data=await req.json().catch(()=>({})); const parsed=schema.safeParse(data); if(!parsed.success) return NextResponse.json({error:parsed.error.flatten()},{status:400}); await sendOwnerEmail('New Lead', `<pre>${JSON.stringify(parsed.data,null,2)}</pre>`); try{ if(process.env.SUPABASE_URL){ const supa=getSupabaseServiceClient(); const { data: cust } = await supa.from('customers').insert({ email: parsed.data.email, phone: parsed.data.phone, name: parsed.data.name }).select().single(); await supa.from('leads').insert({ customer_id: cust?.id, source: 'web', status: 'new', payload: parsed.data }); } }catch(e){ console.warn('Supabase insert skipped:', e); } return NextResponse.json({ok:true}); }