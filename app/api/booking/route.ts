import { NextRequest,NextResponse } from 'next/server'; import { bookingSchema } from '@/lib/validators'; import { createHold } from '@/lib/calendar'; import { sendOwnerEmail } from '@/lib/email'; import { getSupabaseServiceClient } from '@/server/supabase'; export async function POST(req:NextRequest){ const data=await req.json().catch(()=>({})); const parsed=bookingSchema.safeParse(data); if(!parsed.success) return NextResponse.json({error:parsed.error.flatten()},{status:400}); const start=new Date(`${parsed.data.date}T${parsed.data.time}:00`); const end=new Date(start.getTime()+2*60*60*1000); const hold=createHold(start.toISOString(),end.toISOString(),`Hold: ${parsed.data.service}`); await sendOwnerEmail('New Booking Request (Hold Placed)', `<pre>${JSON.stringify({...parsed.data,hold},null,2)}</pre>`); try{ if(process.env.SUPABASE_URL){ const supa=getSupabaseServiceClient(); const { data: cust } = await supa.from('customers').insert({ email: parsed.data.email, phone: parsed.data.phone, name: `${parsed.data.firstName} ${parsed.data.lastName}` }).select().single(); const { data: lead } = await supa.from('leads').insert({ customer_id: cust?.id, source: 'web', status: 'qualified', payload: parsed.data }).select().single(); await supa.from('bookings').insert({ lead_id: lead?.id, start_time: start.toISOString(), end_time: end.toISOString(), address: parsed.data.address, status: 'hold', notes: parsed.data.notes }); } }catch(e){ console.warn('Supabase insert skipped:', e); } return NextResponse.json({ok:true,hold}); }